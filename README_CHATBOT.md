# AMAST Database Chatbot

A terminal-based chatbot that answers questions about the AMAST database using Alibaba Qwen LLM.

## Setup

1. **Install dependencies:**
```bash
npm install
```

2. **Set environment variables** (or use defaults):
```bash
export DB_HOST=47.250.116.135
export DB_PORT=5432
export DB_NAME=nv_ams
export DB_USER=dev_chatbot
export DB_PASSWORD=Dev3!0PerDev3!0PingDev3!0Ped

export ALIBABA_LLM_API_KEY=sk-65507ea4e9884c378d635a38d0bb2a6f
export ALIBABA_LLM_API_BASE_URL=https://dashscope-intl.aliyuncs.com/compatible-mode/v1
export ALIBABA_LLM_API_MODEL=qwen-plus
```

**Windows PowerShell:**
```powershell
$env:DB_HOST="47.250.116.135"
$env:DB_PORT="5432"
$env:DB_NAME="nv_ams"
$env:DB_USER="dev_chatbot"
$env:DB_PASSWORD="Dev3!0PerDev3!0PingDev3!0Ped"

$env:ALIBABA_LLM_API_KEY="sk-65507ea4e9884c378d635a38d0bb2a6f"
$env:ALIBABA_LLM_API_BASE_URL="https://dashscope-intl.aliyuncs.com/compatible-mode/v1"
$env:ALIBABA_LLM_API_MODEL="qwen-plus"
```

## Usage

Run the chatbot:
```bash
node chatbot.js
```

Or:
```bash
npm start
```

## How It Works

The chatbot uses a **three-stage process**:

1. **Stage 1: Table Identification**
   - Analyzes your question
   - Identifies relevant database tables (3-15 tables)
   - Uses lightweight schema summary

2. **Stage 2: SQL Generation**
   - Generates SQL query using identified tables
   - Handles year partitioning, relationships, and business terminology
   - Validates query safety

3. **Stage 3: Result Refinement**
   - Executes SQL query
   - Formats results into natural language
   - Provides clear, informative answers

## Example Questions

- "What was the revenue last month?"
- "Show me top 10 outlets by sales"
- "How many invoices were created today?"
- "Compare sales this year and last year"
- "What are the top selling products?"
- "Show me delivery orders from last week"

## Commands

- Type your question and press Enter
- Type `exit` or `quit` to end the session
- Type `clear` or `reset` to clear chat history

## Requirements

- Node.js (v14 or higher)
- PostgreSQL database access
- Alibaba Qwen API access
- Schema file: `output/database-schema.json` (generated by schema analyzer)

## Troubleshooting

### Database Connection Issues
- Check network connectivity
- Verify database credentials
- Try enabling SSL: `export DB_SSL=true`

### API Issues
- Verify API key is correct
- Check API endpoint URL
- Ensure you have API credits/quota

### Schema Not Found
- Run schema analyzer first: `node scripts/analyze-schema.js`
- Ensure `output/database-schema.json` exists

## Notes

- The chatbot maintains conversation history for context
- SQL queries are limited to SELECT only (read-only)
- Large result sets are automatically limited to 1000 rows
- Year-partitioned tables are automatically selected based on date ranges






